<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>NULS Revision Techniques</title>
<style>
body {
    font-family: Arial;
    margin: 0;
    padding: 20px;
    background: #f4f4f4;
}

#top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: #f5f5f5;
    height: 60px;
    box-sizing: border-box;
}

#top-right {
    display: flex;
    gap: 10px;
    align-items: center;
}

#top-right a, #top-right button {
    height: 36px;
    min-width: 80px;
    padding: 0 12px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: normal;
    cursor: pointer;
}

#admin-btn { background-color: #6c757d; color: white; }
#tos-link { background-color: #6c757d; color: white; }
#logout-btn { background-color: #dc3545; color: white; }

#main {
    display: flex;
    height: 85vh;
    background: white;
    border-radius: 6px;
    overflow: hidden;
}

#sidebar {
    width: 240px;
    border-right: 1px solid #ccc;
    padding: 10px;
    background: #fafafa;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    height: 100%;
}

#sidebar > ul:first-of-type { margin: 0 0 12px 0; padding: 0; list-style: none; flex: 0 0 auto; }
#sidebar h4 { margin: 0 0 8px 0; flex: 0 0 auto; }

#dm-users {
    list-style: none;
    padding: 0;
    margin: 0;
    overflow-y: auto;
    flex: 1 1 auto;
}

#dm-users li {
    padding: 10px;
    cursor: pointer;
    border-radius: 4px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#sidebar ul { list-style: none; padding: 0; margin: 0; }
#sidebar li { padding: 10px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; }
#sidebar li:hover { background: #e6e6e6; }
#sidebar li.active { background: #007bff; color: white; }

#chat-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

#chat {
    flex-grow: 1;
    padding: 10px;
    overflow-y: auto;
    background: #f9f9f9;
    border-bottom: 1px solid #ccc;
}

#chat div { max-width: 100%; word-break: break-word; overflow-wrap: break-word; }

#msgForm { display: flex; }
#msg { flex-grow: 1; padding: 12px; border: none; outline: none; font-size: 16px; }
#msgForm button { padding: 12px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
#msgForm button:hover { background: #0056b3; }

.badge {
    background: red;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 12px;
    margin-left: 5px;
    display: inline-block;
    min-width: 16px;
    text-align: center;
}

#tos-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
#tos-content { background: white; padding: 30px; border-radius: 8px; width: 80%; max-width: 600px; height: 80%; overflow-y: auto; position: relative; }
#tos-content h3 { margin-top: 0; }
#tos-close { position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
#tos-close:hover { background: #c82333; }
</style>
</head>
<body>

<div id="top-bar">
    <span>Logged in as <b id="current-user">{{ current_user.username }}</b></span>
    <div id="top-right">
        {% if is_user_admin %} 
        <a id="admin-btn" href="/admin" class="btn">Admin</a>
        {% endif %}
        <a href="#" id="tos-link">Terms of Service</a>
        <a href="/logout" id="logout-btn">Logout</a>
    </div>
</div>

<div id="main">
    <div id="sidebar">
        <ul>
            <li class="active" data-target="global_chat">
                Global Chat <span class="badge" id="global-badge" style="display:none;"></span>
            </li>
        </ul>
        <h4>DM Users</h4>
        <ul id="dm-users"></ul>
    </div>

    <div id="chat-container">
        <div id="chat"></div>
        <form id="msgForm">
            <input id="msg" placeholder="Message" autocomplete="off">
            <button>Send</button>
        </form>
    </div>
</div>

<!-- TOS Modal -->
<div id="tos-modal">
    <div id="tos-content">
        <h3>Terms of Service</h3>
        <p>
            Welcome to the NULS Revisions Techniques! By using this service, you agree not to misuse it, harass others, or attempt unauthorized access. Additionally, you must agree not to put tennis balls on James' head.
        </p>
        <p>Violations may result in account suspension or banning.</p>
        <button id="tos-close">Close</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
var socket = io();
var chat = document.getElementById("chat");
var msgInput = document.getElementById("msg");
var userName = document.getElementById("current-user").textContent;
var currentTarget = "global_chat";
var oldestMessageId = null;
var hasMoreHistory = true;
var isLoadingHistory = false;
var lastDatePerTarget = {}; // keeps track of the last displayed date per chat

// --------------- DATE/TIME FORMATTING ---------------
function formatTimeUKFromISO(isoStr) {
    const date = new Date(isoStr);
    return new Intl.DateTimeFormat('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/London' }).format(date);
}

function formatDateHeaderUK(dateStr) {
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat('en-GB', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric', timeZone: 'Europe/London' }).format(date);
}

function getMessageDate(msg){
    if(msg.date) return msg.date; // use stored date if present
    if(msg.timestamp) return msg.timestamp.split('T')[0]; // fallback to timestamp
    return new Date().toISOString().split('T')[0]; // default to today
}

function ensureDateHeader(target, msgDate){
    if(lastDatePerTarget[target] !== msgDate){
        lastDatePerTarget[target] = msgDate;
        const dateDiv = document.createElement("div");
        dateDiv.classList.add("day-header");
        dateDiv.setAttribute("data-date", msgDate);
        dateDiv.textContent = formatDateHeaderUK(msgDate);
        dateDiv.style.textAlign = "center";
        dateDiv.style.margin = "10px 0";
        dateDiv.style.fontWeight = "bold";
        chat.appendChild(dateDiv);
    }
}


// --------------- SOCKET EVENTS ---------------
socket.on("connect", function() {
    socket.emit("get_users");
    socket.emit("request_history", { target: currentTarget });
});

socket.on("registered_users", function(users) {
    var list = document.getElementById("dm-users");
    list.innerHTML = "";
    users.forEach(function(u) {
        if(u !== userName){
            var li = document.createElement("li");
            li.setAttribute("data-user", u);
            li.innerHTML = u + ' <span class="badge"></span>';
            li.onclick = function(){
                currentTarget = u;
                document.querySelectorAll("#sidebar li, #dm-users li").forEach(x=>x.classList.remove("active"));
                li.classList.add("active");
                chat.innerHTML = "";
                oldestMessageId = null;
                hasMoreHistory = true;
                socket.emit("request_history", { target: currentTarget });
            };
            list.appendChild(li);
        }
    });
});

document.querySelector('#sidebar li[data-target="global_chat"]').onclick = function(){
    currentTarget = "global_chat";
    document.querySelectorAll("#sidebar li, #dm-users li").forEach(x => x.classList.remove("active"));
    this.classList.add("active");
    chat.innerHTML = "";
    oldestMessageId = null;
    hasMoreHistory = true;
    socket.emit("request_history", { target: currentTarget });
};

// --------------- HISTORY HANDLING ---------------
function getMessageDate(msg) {
    if(msg.date) return msg.date;
    if(msg.timestamp) return msg.timestamp.split('T')[0];
    return new Date().toISOString().split('T')[0];
}

// ---------------- HISTORY HANDLING ----------------
socket.on("history", function(data){
    if(data.target !== currentTarget) return;

    let prevScrollHeight = chat.scrollHeight;
    let prevScrollTop = chat.scrollTop;

    data.messages.forEach(function(msg){
        const msgDate = getMessageDate(msg);

        // insert date header if last header is different
        const lastDayHeader = chat.querySelector(".day-header:last-of-type");
        if(!lastDayHeader || lastDayHeader.getAttribute("data-date") !== msgDate){
            const dateDiv = document.createElement("div");
            dateDiv.classList.add("day-header");
            dateDiv.setAttribute("data-date", msgDate);
            dateDiv.textContent = formatDateHeaderUK(msgDate);
            dateDiv.style.textAlign = "center";
            dateDiv.style.margin = "10px 0";
            dateDiv.style.fontWeight = "bold";
            chat.appendChild(dateDiv);
        }

        const div = document.createElement("div");
        const time = msg.timestamp ? formatTimeUKFromISO(msg.timestamp) : '';
        div.textContent = `[${time}] ${msg.msg}`;
        div.style.wordBreak = "break-word";
        chat.appendChild(div);

        oldestMessageId = msg.id;
    });

    hasMoreHistory = data.has_more;

    // only scroll to bottom on initial load
    if(!isLoadingHistory) chat.scrollTop = chat.scrollHeight;
    isLoadingHistory = false;
});

// ---------------- LIVE MESSAGES ----------------
socket.on("live_message", function(data){
    if((data.is_global && currentTarget=="global_chat") || 
       (!data.is_global && (data.sender==currentTarget || data.recipient==currentTarget))){

        const msgDate = getMessageDate(data);

        const lastDayHeader = chat.querySelector(".day-header:last-of-type");
        if(!lastDayHeader || lastDayHeader.getAttribute("data-date") !== msgDate){
            const dateDiv = document.createElement("div");
            dateDiv.classList.add("day-header");
            dateDiv.setAttribute("data-date", msgDate);
            dateDiv.textContent = formatDateHeaderUK(msgDate);
            dateDiv.style.textAlign = "center";
            dateDiv.style.margin = "10px 0";
            dateDiv.style.fontWeight = "bold";
            chat.appendChild(dateDiv);
        }

        const div = document.createElement("div");
        const time = data.timestamp ? formatTimeUKFromISO(data.timestamp) : '';
        div.textContent = `[${time}] ${data.msg}`;
        div.style.wordBreak = "break-word";
        chat.appendChild(div);

        // scroll to bottom on live message
        requestAnimationFrame(() => {
            chat.scrollTop = chat.scrollHeight;
        });
    }
});



// --------------- SCROLL TO LOAD ---------------
chat.addEventListener("scroll", function(){
    if(chat.scrollTop === 0 && hasMoreHistory && !isLoadingHistory){
        isLoadingHistory = true;
        socket.emit("request_history", { target: currentTarget, before_id: oldestMessageId });
    }
});


// --------------- UNREAD BADGES ---------------
socket.on("unread_counts", function(counts){
    console.log("DEBUG: unread_counts payload", counts); // <-- debug

    var globalBadge = document.getElementById("global-badge");
    var globalCount = parseInt(counts.global) || 0;
    console.log("DEBUG: globalCount parsed:", globalCount); // <-- debug

    globalBadge.style.display = globalCount > 0 ? "inline-block" : "none";
    globalBadge.textContent = globalCount || "";

    document.querySelectorAll("#dm-users li").forEach(function(li){
        var user = li.getAttribute("data-user");
        var badge = li.querySelector(".badge");
        badge.style.display = counts[user] > 0 ? "inline-block" : "none";
        badge.textContent = counts[user] || "";
    });
});

// --------------- SEND MESSAGE ---------------
document.getElementById("msgForm").onsubmit = function(e){
    e.preventDefault();
    if(msgInput.value.trim()==="") return;
    socket.emit("store_and_send", {msg: msgInput.value, target: currentTarget});
    msgInput.value="";
};

// --------------- TOS MODAL ---------------
document.getElementById("tos-link").onclick = function(e){ e.preventDefault(); document.getElementById("tos-modal").style.display="flex"; };
document.getElementById("tos-close").onclick = function(){ document.getElementById("tos-modal").style.display="none"; };
</script>

</body>
</html>